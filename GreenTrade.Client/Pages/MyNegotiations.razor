@page "/negotiations"
@using GreenTrade.Shared.DTOs
@using GreenTrade.Shared.Enums
@using GreenTrade.Client.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject OfferService OfferService
@inject NotificationService Notifications
@inject FormatterService Formatter

<PageTitle>Negociações - GreenTrade</PageTitle>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h4 class="text-white mb-0"><i class="bx bx-briefcase-alt-2 me-2"></i> Negociações</h4>
                <p class="mb-0">Gerencie suas propostas de compra e venda.</p>
            </div>
        </div>
    </div>
</div>

<div class="nav-align-top mb-4">
    <ul class="nav nav-tabs nav-fill" role="tablist">
        <li class="nav-item">
            <button type="button" class="nav-link @(activeTab == "received" ? "active" : "")" 
                    @onclick="@(() => activeTab = "received")">
                <i class="bx bx-down-arrow-circle me-1"></i> Recebidas
            </button>
        </li>
        <li class="nav-item">
            <button type="button" class="nav-link @(activeTab == "sent" ? "active" : "")" 
                    @onclick="@(() => activeTab = "sent")">
                <i class="bx bx-up-arrow-circle me-1"></i> Enviadas
            </button>
        </li>
    </ul>
    
    <div class="tab-content">
        <!-- RECEIVED OFFERS TAB -->
        <div class="tab-pane fade @(activeTab == "received" ? "show active" : "")">
            @if (receivedOffers == null)
            {
                <div class="text-center p-3"><div class="spinner-border text-primary"></div></div>
            }
            else if (!receivedOffers.Any())
            {
                <div class="alert alert-info m-3">Nenhuma proposta recebida até o momento.</div>
            }
            else
            {
                <div class="table-responsive text-nowrap">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Lote</th>
                                <th>Comprador</th>
                                <th>Oferta (Saca)</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var offer in receivedOffers)
                            {
                                <tr>
                                    <td><strong>@offer.CoffeeLotDescription</strong></td>
                                    <td>@offer.BuyerName</td>
                                    <td class="text-primary fw-bold">@Formatter.FormatCurrency(offer.PricePerBag)</td>
                                    <td>@Formatter.FormatCurrency(offer.TotalAmount)</td>
                                    <td>@RenderStatusBadge(offer.Status)</td>
                                    <td>@offer.CreatedAt.ToString("dd/MM HH:mm")</td>
                                    <td>
                                        @if (offer.Status == "Pending" || offer.Status == "Countered")
                                        {
                                            <button class="btn btn-sm btn-success me-1" @onclick='() => Respond(offer.Id, "Accepted")' title="Aceitar">
                                                <i class="bx bx-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-info me-1" @onclick="() => OpenCounterModal(offer)" data-bs-toggle="modal" data-bs-target="#counterOfferModal" title="Contraproposta">
                                                <i class="bx bx-edit-alt"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" @onclick='() => Respond(offer.Id, "Rejected")' title="Recusar">
                                                <i class="bx bx-x"></i>
                                            </button>
                                        }
                                        else if (offer.Status == "Accepted")
                                        {
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => OpenContractModal(offer)" data-bs-toggle="modal" data-bs-target="#contractModal">
                                                <i class="bx bx-file me-1"></i> Contrato
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        <!-- SENT OFFERS TAB -->
        <div class="tab-pane fade @(activeTab == "sent" ? "show active" : "")">
            @if (sentOffers == null)
            {
                <div class="text-center p-3"><div class="spinner-border text-primary"></div></div>
            }
            else if (!sentOffers.Any())
            {
                <div class="alert alert-info m-3">Você ainda não enviou propostas.</div>
            }
            else
            {
                <div class="table-responsive text-nowrap">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Lote</th>
                                <th>Oferta (Saca)</th>
                                <th>Status</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var offer in sentOffers)
                            {
                                <tr>
                                    <td><strong>@offer.CoffeeLotDescription</strong></td>
                                    <td class="text-primary fw-bold">@Formatter.FormatCurrency(offer.PricePerBag)</td>
                                    <td>@RenderStatusBadge(offer.Status)</td>
                                    <td>@offer.CreatedAt.ToString("dd/MM HH:mm")</td>
                                    <td>
                                        @if (offer.Status == "Countered")
                                        {
                                            <button class="btn btn-sm btn-success me-1" @onclick='() => Respond(offer.Id, "Accepted")' title="Aceitar Contraproposta">
                                                <i class="bx bx-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-info me-1" @onclick="() => OpenCounterModal(offer)" data-bs-toggle="modal" data-bs-target="#counterOfferModal" title="Nova Contraproposta">
                                                <i class="bx bx-edit-alt"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" @onclick='() => Respond(offer.Id, "Rejected")' title="Recusar">
                                                <i class="bx bx-x"></i>
                                            </button>
                                        }
                                        else if (offer.Status == "Pending")
                                        {
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => Cancel(offer.Id)" title="Cancelar Proposta">
                                                <i class="bx bx-trash"></i> Cancelar
                                            </button>
                                        }
                                        else if (offer.Status == "Accepted")
                                        {
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => OpenContractModal(offer)" data-bs-toggle="modal" data-bs-target="#contractModal">
                                                <i class="bx bx-file me-1"></i> Contrato
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Counter Offer Modal -->
<div class="modal fade" id="counterOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fazer Contraproposta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @if (selectedOffer != null)
                {
                    <div class="alert alert-light border mb-3">
                        <small class="text-muted d-block">Preço Atual:</small>
                        <span class="fw-bold">@Formatter.FormatCurrency(selectedOffer.PricePerBag)</span>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Novo Preço por Saca (R$)</label>
                        <input type="number" class="form-control" @bind="counterData.CounterPrice" step="0.01" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observações / Condições</label>
                        <textarea class="form-control" @bind="counterData.Remarks" rows="3" placeholder="Ex: Pagamento à vista, entrega em 30 dias..."></textarea>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" @onclick="SubmitCounterOffer">Enviar Contraproposta</button>
            </div>
        </div>
    </div>
</div>

<!-- Contract Summary Modal -->
<div class="modal fade" id="contractModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header border-bottom">
                <h5 class="modal-title">Resumo do Contrato Digital</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="printableContract">
                @if (selectedOffer != null)
                {
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="text-start">
                            <h4 class="mb-0 text-primary fw-bold">GreenTrade Core</h4>
                            <small class="text-muted text-uppercase">Comprovante de Negociação Agrícola</small>
                        </div>
                        <div class="text-end">
                            <div class="border border-success rounded p-2 text-success" style="border-width: 2px !important; transform: rotate(-5deg); opacity: 0.8;">
                                <small class="fw-bold d-block">AUTENTICADO</small>
                                <span class="small" style="font-size: 0.6rem;">REGISTRO: @selectedOffer.Id.ToString("D8")</span>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-6">
                            <h6 class="fw-bold text-uppercase small text-muted mb-2">Vendedor</h6>
                            <p class="mb-0">@selectedOffer.SellerName</p>
                        </div>
                        <div class="col-6 text-end">
                            <h6 class="fw-bold text-uppercase small text-muted mb-2">Comprador</h6>
                            <p class="mb-0">@selectedOffer.BuyerName</p>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered bg-light">
                            <tbody>
                                <tr>
                                    <th class="w-50 text-uppercase small">Produto</th>
                                    <td>@selectedOffer.CommodityName</td>
                                </tr>
                                <tr>
                                    <th class="text-uppercase small">Quantidade</th>
                                    <td>@selectedOffer.Quantity sacas (60kg)</td>
                                </tr>
                                <tr>
                                    <th class="text-uppercase small">Preço Fechado</th>
                                    <td class="fw-bold text-success">@Formatter.FormatCurrency(selectedOffer.PricePerBag) / saca</td>
                                </tr>
                                <tr>
                                    <th class="text-uppercase small">Total da Operação</th>
                                    <td class="fw-bold">@Formatter.FormatCurrency(selectedOffer.TotalAmount)</td>
                                </tr>
                                <tr>
                                    <th class="text-uppercase small">Local de Entrega</th>
                                    <td>@selectedOffer.WarehouseName - @selectedOffer.WarehouseCity</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    @if (!string.IsNullOrEmpty(selectedOffer.Remarks))
                    {
                        <div class="mt-4">
                            <h6 class="fw-bold text-uppercase small text-muted mb-2">Observações Adicionais</h6>
                            <div class="p-3 bg-light rounded font-italic">
                                "@selectedOffer.Remarks"
                            </div>
                        </div>
                    }

                    <div class="mt-5 pt-4 text-center border-top">
                        <small class="text-muted">Documento gerado em @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</small>
                        <br />
                        <small class="text-muted">ID da Transação: #OFF-@selectedOffer.Id.ToString("D6")</small>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="bx bx-printer me-1"></i> Imprimir Resumo
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private string activeTab = "received";
    private List<OfferDto>? receivedOffers;
    private List<OfferDto>? sentOffers;
    
    private OfferDto? selectedOffer;
    private UpdateOfferStatusDto counterData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOffers();
    }

    private async Task LoadOffers()
    {
        var t1 = OfferService.GetReceivedOffers();
        var t2 = OfferService.GetMySentOffers();
        
        await Task.WhenAll(t1, t2);
        
        receivedOffers = t1.Result;
        sentOffers = t2.Result;
    }

    private void OpenCounterModal(OfferDto offer)
    {
        selectedOffer = offer;
        counterData = new UpdateOfferStatusDto 
        { 
            NewStatus = "Countered", 
            CounterPrice = offer.PricePerBag,
            Remarks = ""
        };
    }

    private void OpenContractModal(OfferDto offer)
    {
        selectedOffer = offer;
    }

    private async Task SubmitCounterOffer()
    {
        if (selectedOffer == null) return;
        
        if (counterData.CounterPrice <= 0)
        {
            Notifications.ShowError("O preço deve ser maior que zero.");
            return;
        }

        await Respond(selectedOffer.Id, "Countered", counterData.CounterPrice, counterData.Remarks);
    }

    private async Task Cancel(int id)
    {
        try
        {
            await OfferService.CancelOffer(id);
            Notifications.ShowInfo("Proposta cancelada.");
            await LoadOffers();
        }
        catch (Exception)
        {
            Notifications.ShowError("Erro ao cancelar proposta.");
        }
    }

    private async Task Respond(int id, string status, decimal? price = null, string? remarks = null)
    {
        try 
        {
            var dto = new UpdateOfferStatusDto 
            { 
                NewStatus = status, 
                CounterPrice = price, 
                Remarks = remarks 
            };
            
            await OfferService.RespondToOffer(id, dto);
            
            string msg = status switch {
                "Accepted" => "Oferta aceita!",
                "Rejected" => "Oferta recusada.",
                "Countered" => "Contraproposta enviada!",
                _ => "Resposta enviada."
            };
            
            Notifications.ShowSuccess(msg);
            await LoadOffers();
        }
        catch (Exception)
        {
            Notifications.ShowError("Erro ao processar resposta.");
        }
    }

    private RenderFragment RenderStatusBadge(string status) => builder =>
    {
        var badgeClass = status switch
        {
            "Pending" => "bg-label-warning",
            "Accepted" => "bg-label-success",
            "Rejected" => "bg-label-danger",
            "Countered" => "bg-label-info",
            _ => "bg-label-secondary"
        };
        
        var ptStatus = status switch
        {
            "Pending" => "Pendente",
            "Accepted" => "Aceita",
            "Rejected" => "Recusada",
            "Countered" => "Contraproposta",
            "Cancelled" => "Cancelada",
            _ => status
        };

        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "class", $"badge {badgeClass}");
        builder.AddContent(2, ptStatus);
        builder.CloseElement();
    };
}
