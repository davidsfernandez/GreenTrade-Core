@page "/"
@using Microsoft.AspNetCore.Authorization
@using GreenTrade.Client.Services
@using GreenTrade.Client.Components
@using GreenTrade.Shared.DTOs
@using GreenTrade.Shared.Models
@using GreenTrade.Shared.Services
@attribute [Authorize]
@inject MarketDataClientService MarketService
@inject IPriceCalculatorService CalculatorService
@inject FormatterService Formatter
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@implements IDisposable

<PageTitle>Dashboard - GreenTrade</PageTitle>

<div class="row">
    <!-- Welcome Card -->
    <div class="col-lg-8 mb-4 order-0">
        <div class="card">
            <div class="d-flex align-items-end row">
                <div class="col-sm-7">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Bom dia, @(string.IsNullOrEmpty(UserName) ? "Usu√°rio" : UserName)! üéâ</h5>
                        <p class="mb-4">
                            O mercado de caf√© est√° aquecido hoje. Confira as cota√ß√µes em tempo real e utilize nossa calculadora.
                        </p>

                        <a href="quotes" class="btn btn-sm btn-outline-primary">Ver Cota√ß√µes</a>
                    </div>
                </div>
                <div class="col-sm-5 text-center text-sm-left">
                    <div class="card-body pb-0 px-0 px-md-4">
                        <img src="sneat/assets/img/illustrations/man-with-laptop-light.png"
                             height="140"
                             alt="View Badge User"
                             data-app-dark-img="illustrations/man-with-laptop-dark.png"
                             data-app-light-img="illustrations/man-with-laptop-light.png" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--/ Welcome Card -->

    <!-- Tickers -->
    <div class="col-lg-4 col-md-4 order-1">
        <div class="row">
            <!-- Caf√© Ar√°bica -->
            <div class="col-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <span class="avatar-initial rounded bg-label-success"><i class="bx bx-coffee"></i></span>
                            </div>
                        </div>
                        <span class="fw-semibold d-block mb-1">Ar√°bica (KC)</span>
                        <h3 class="card-title mb-2">@Formatter.FormatCurrency(arabicaPrice.CurrentPrice)</h3>
                        <small class="@(arabicaPrice.ChangePercentage >= 0 ? "text-success" : "text-danger") fw-semibold">
                            <i class="bx @(arabicaPrice.ChangePercentage >= 0 ? "bx-up-arrow-alt" : "bx-down-arrow-alt")"></i> @(arabicaPrice.ChangePercentage)%
                        </small>
                    </div>
                </div>
            </div>

            <!-- Caf√© Conilon -->
            <div class="col-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <span class="avatar-initial rounded bg-label-warning"><i class="bx bx-coffee-togo"></i></span>
                            </div>
                        </div>
                        <span class="fw-semibold d-block mb-1">Conilon (C8)</span>
                        <h3 class="card-title mb-2">@Formatter.FormatCurrency(conilonPrice.CurrentPrice)</h3>
                        <small class="@(conilonPrice.ChangePercentage >= 0 ? "text-success" : "text-danger") fw-semibold">
                            <i class="bx @(conilonPrice.ChangePercentage >= 0 ? "bx-up-arrow-alt" : "bx-down-arrow-alt")"></i> @(conilonPrice.ChangePercentage)%
                        </small>
                    </div>
                </div>
            </div>
            
             <!-- D√≥lar -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-body">
                         <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <span class="avatar-initial rounded bg-label-info"><i class="bx bx-dollar"></i></span>
                            </div>
                        </div>
                        <span class="fw-semibold d-block mb-1">D√≥lar Comercial (USDBRL)</span>
                        <h3 class="card-title mb-2">@Formatter.FormatCurrency(dollarPrice.CurrentPrice)</h3>
                        <small class="@(dollarPrice.ChangePercentage >= 0 ? "text-success" : "text-danger") fw-semibold">
                            <i class="bx @(dollarPrice.ChangePercentage >= 0 ? "bx-up-arrow-alt" : "bx-down-arrow-alt")"></i> @(dollarPrice.ChangePercentage)%
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--/ Tickers -->
</div>

<div class="row">
    <!-- Main Chart -->
    <div class="col-12 col-lg-8 order-2 order-md-3 order-lg-2 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between pb-0">
                <div class="card-title mb-0">
                    <h5 class="m-0 me-2">Hist√≥rico de Pre√ßos (TradingView)</h5>
                    <small class="text-muted">Ar√°bica (KC) com SMA 14</small>
                </div>
            </div>
            <div class="card-body">
                <div id="incomeChart" style="height: 300px; width: 100%;"></div>
            </div>
        </div>
    </div>
    <!--/ Main Chart -->

    <!-- Quick Calculator -->
    <div class="col-md-6 col-lg-4 order-2 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title m-0 me-2">Calculadora R√°pida</h5>
                <div class="dropdown">
                    <button class="btn p-0" type="button" id="calcOptions" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="bx bx-dots-vertical-rounded"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="calcOptions">
                        <a class="dropdown-item" href="javascript:void(0);" @onclick="UseMarketPrices">Usar Pre√ßos Atuais</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <ul class="p-0 m-0">
                    <li class="d-flex mb-4 pb-1">
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <h6 class="mb-0">NY (cts/lb)</h6>
                                <input type="number" step="0.01" class="form-control form-control-sm mt-1" @bind="nyPrice" @bind:event="oninput" style="width: 100px;" />
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <h6 class="mb-0">D√≥lar (R$)</h6>
                                <input type="number" step="0.0001" class="form-control form-control-sm mt-1" @bind="dollarRate" @bind:event="oninput" style="width: 100px;" />
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                         <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <h6 class="mb-0">Diferencial (R$)</h6>
                                <input type="number" step="1" class="form-control form-control-sm mt-1" @bind="basis" @bind:event="oninput" style="width: 100px;" />
                            </div>
                        </div>
                    </li>
                </ul>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary d-grid w-100" @onclick="Calculate">Calcular Agora</button>
                </div>
                
                 @if (calculatedPrice > 0)
                {
                    <div class="mt-3 text-center">
                        <small class="text-muted">Pre√ßo Sugerido (60kg)</small>
                        <h3 class="text-success mt-1">@Formatter.FormatCurrency(calculatedPrice)</h3>
                    </div>
                }
            </div>
        </div>
    </div>
    <!--/ Quick Calculator -->
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState>? authenticationStateTask { get; set; }
    private string UserName = "";

    private PriceUpdateDto arabicaPrice = new() { Ticker = "KC", CurrentPrice = 185.50m };
    private PriceUpdateDto conilonPrice = new() { Ticker = "C8", CurrentPrice = 145.20m };
    private PriceUpdateDto dollarPrice = new() { Ticker = "USDBRL", CurrentPrice = 5.25m };

    // Calculator State
    private decimal nyPrice;
    private decimal dollarRate;
    private decimal basis;
    private decimal calculatedPrice;

    // Chart Data
    private List<ChartDataPoint> chartData = new();
    private List<decimal> priceHistory = new();
    private int smaPeriod = 14;

    protected override async Task OnInitializedAsync()
    {
        if (authenticationStateTask != null)
        {
            var authState = await authenticationStateTask;
            UserName = authState.User.Identity?.Name ?? "";
        }

        MarketService.OnPriceUpdate += HandlePriceUpdate;
        await MarketService.StartAsync();

        nyPrice = arabicaPrice.CurrentPrice;
        dollarRate = dollarPrice.CurrentPrice;
        
        // Seed initial history
        AddPriceHistory(arabicaPrice.CurrentPrice);

        try
        {
            var settings = await Http.GetFromJsonAsync<MarketSettings>("api/marketsettings");
            if (settings != null)
            {
                basis = settings.CoffeeBasis;
            }
        }
        catch { }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize Chart
            await JSRuntime.InvokeVoidAsync("window.appInterop.createTradingViewChart", "incomeChart", chartData);
            // Initialize SMA Series (empty initially)
            await JSRuntime.InvokeVoidAsync("window.appInterop.addIndicatorSeries", "incomeChart", "SMA", "#ff9f43", new List<object>()); 
        }
    }

    private void HandlePriceUpdate(PriceUpdateDto update)
    {
        switch (update.Ticker)
        {
            case "KC":
                arabicaPrice = update;
                var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
                var dataPoint = new ChartDataPoint { time = now, value = (double)update.CurrentPrice };
                
                // Update Main Chart
                JSRuntime.InvokeVoidAsync("window.appInterop.updateTradingViewChart", "incomeChart", dataPoint);
                
                // Update History & Indicators
                AddPriceHistory(update.CurrentPrice);
                UpdateIndicators(now);
                break;
            case "C8": conilonPrice = update; break;
            case "USDBRL": dollarPrice = update; break;
        }
        InvokeAsync(StateHasChanged);
    }

    private void AddPriceHistory(decimal price)
    {
        priceHistory.Add(price);
        if (priceHistory.Count > 100) priceHistory.RemoveAt(0); // Keep last 100
        chartData.Add(new ChartDataPoint { time = DateTimeOffset.UtcNow.ToUnixTimeSeconds(), value = (double)price });
    }

    private void UpdateIndicators(long timestamp)
    {
        if (priceHistory.Count >= smaPeriod)
        {
            var smaValues = TechnicalIndicatorsService.CalculateSMA(priceHistory, smaPeriod);
            var currentSMA = smaValues.LastOrDefault();
            if (currentSMA > 0)
            {
                var smaPoint = new { time = timestamp, value = (double)currentSMA };
                JSRuntime.InvokeVoidAsync("window.appInterop.updateIndicatorSeries", "incomeChart", "SMA", smaPoint);
            }
        }
    }

    private void UseMarketPrices()
    {
        nyPrice = arabicaPrice.CurrentPrice;
        dollarRate = dollarPrice.CurrentPrice;
        Calculate();
    }

    private void Calculate()
    {
        calculatedPrice = CalculatorService.CalculateCoffeeBagPrice(nyPrice, dollarRate, basis);
    }

    public void Dispose()
    {
        MarketService.OnPriceUpdate -= HandlePriceUpdate;
    }

    public class ChartDataPoint
    {
        public long time { get; set; }
        public double value { get; set; }
    }
}
