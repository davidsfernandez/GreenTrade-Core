@page "/"
@using Microsoft.AspNetCore.Authorization
@using GreenTrade.Client.Services
@using GreenTrade.Client.Components
@using GreenTrade.Shared.DTOs
@using GreenTrade.Shared.Models
@using GreenTrade.Shared.Services
@attribute [Authorize]
@inject MarketDataClientService MarketService
@inject IPriceCalculatorService CalculatorService
@inject FormatterService Formatter
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@implements IDisposable

<PageTitle>Dashboard - GreenTrade</PageTitle>

<div class="row">
    <!-- Welcome Card -->
    <div class="col-lg-8 mb-4 order-0">
        <div class="card">
            <div class="d-flex align-items-end row">
                <div class="col-sm-7">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Bom dia, @(string.IsNullOrEmpty(UserName) ? "Usu√°rio" : UserName)! üéâ</h5>
                        <p class="mb-4">
                            O mercado de caf√© est√° aquecido hoje. Confira as cota√ß√µes em tempo real e utilize nossa calculadora.
                        </p>

                        <a href="quotes" class="btn btn-sm btn-outline-primary">Ver Cota√ß√µes</a>
                    </div>
                </div>
                <div class="col-sm-5 text-center text-sm-left">
                    <div class="card-body pb-0 px-0 px-md-4">
                        <img src="sneat/assets/img/illustrations/man-with-laptop-light.png"
                             height="140"
                             alt="View Badge User"
                             data-app-dark-img="illustrations/man-with-laptop-dark.png"
                             data-app-light-img="illustrations/man-with-laptop-light.png" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--/ Welcome Card -->

    <!-- Tickers -->
    <div class="col-lg-4 col-md-4 order-1">
        <div class="row">
            <!-- Caf√© Ar√°bica -->
            <div class="col-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <span class="avatar-initial rounded bg-label-success"><i class="bx bx-coffee"></i></span>
                            </div>
                        </div>
                        <span class="fw-semibold d-block mb-1">Ar√°bica (KC)</span>
                        <h3 class="card-title mb-2">@Formatter.FormatCurrency(arabicaPrice.CurrentPrice)</h3>
                        <small class="@(arabicaPrice.ChangePercentage >= 0 ? "text-success" : "text-danger") fw-semibold">
                            <i class="bx @(arabicaPrice.ChangePercentage >= 0 ? "bx-up-arrow-alt" : "bx-down-arrow-alt")"></i> @(arabicaPrice.ChangePercentage)%
                        </small>
                    </div>
                </div>
            </div>

            <!-- Caf√© Conilon -->
            <div class="col-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <span class="avatar-initial rounded bg-label-warning"><i class="bx bx-coffee-togo"></i></span>
                            </div>
                        </div>
                        <span class="fw-semibold d-block mb-1">Conilon (C8)</span>
                        <h3 class="card-title mb-2">@Formatter.FormatCurrency(conilonPrice.CurrentPrice)</h3>
                        <small class="@(conilonPrice.ChangePercentage >= 0 ? "text-success" : "text-danger") fw-semibold">
                            <i class="bx @(conilonPrice.ChangePercentage >= 0 ? "bx-up-arrow-alt" : "bx-down-arrow-alt")"></i> @(conilonPrice.ChangePercentage)%
                        </small>
                    </div>
                </div>
            </div>
            
             <!-- D√≥lar -->
            <div class="col-6 mb-4">
                <div class="card">
                    <div class="card-body">
                         <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <span class="avatar-initial rounded bg-label-info"><i class="bx bx-dollar"></i></span>
                            </div>
                        </div>
                        <span class="fw-semibold d-block mb-1">D√≥lar (USDBRL)</span>
                        <h3 class="card-title mb-2">@Formatter.FormatCurrency(dollarPrice.CurrentPrice)</h3>
                        <small class="@(dollarPrice.ChangePercentage >= 0 ? "text-success" : "text-danger") fw-semibold">
                            <i class="bx @(dollarPrice.ChangePercentage >= 0 ? "bx-up-arrow-alt" : "bx-down-arrow-alt")"></i> @(dollarPrice.ChangePercentage)%
                        </small>
                    </div>
                </div>
            </div>

            <!-- B3 (New) -->
            <div class="col-6 mb-4">
                <div class="card">
                    <div class="card-body">
                         <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <span class="avatar-initial rounded bg-label-primary"><i class="bx bx-bar-chart-alt-2"></i></span>
                            </div>
                        </div>
                        <span class="fw-semibold d-block mb-1">B3 (Ar√°bica)</span>
                        <h3 class="card-title mb-2">@Formatter.FormatCurrency(b3Price.CurrentPrice)</h3>
                        <small class="@(b3Price.ChangePercentage >= 0 ? "text-success" : "text-danger") fw-semibold">
                            <i class="bx @(b3Price.ChangePercentage >= 0 ? "bx-up-arrow-alt" : "bx-down-arrow-alt")"></i> @(b3Price.ChangePercentage)%
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--/ Tickers -->
</div>

<div class="row">
    <!-- Main Chart & RSI -->
    <div class="col-12 col-lg-8 order-2 order-md-3 order-lg-2 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between pb-0">
                <div class="card-title mb-0">
                    <h5 class="m-0 me-2">Hist√≥rico de Pre√ßos (TradingView)</h5>
                    <div class="d-flex gap-3 mt-1">
                        <small class="text-muted">Ar√°bica (KC) com SMA 14 e RSI 14</small>
                        @if (currentSupport > 0)
                        {
                            <small class="text-success fw-bold">SUP: @Formatter.FormatCurrency(currentSupport)</small>
                            <small class="text-danger fw-bold">RES: @Formatter.FormatCurrency(currentResistance)</small>
                        }
                    </div>
                </div>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary @(currentInterval == "15m" ? "active" : "")" @onclick='() => ChangeTimeframe("15m", "1d")'>15m</button>
                    <button type="button" class="btn btn-outline-primary @(currentInterval == "1h" ? "active" : "")" @onclick='() => ChangeTimeframe("1h", "5d")'>1H</button>
                    <button type="button" class="btn btn-outline-primary @(currentInterval == "1d" ? "active" : "")" @onclick='() => ChangeTimeframe("1d", "1mo")'>1D</button>
                </div>
            </div>
            <div class="card-body">
                <div id="incomeChart" style="height: 300px; width: 100%;"></div>
                <div id="rsiChart" style="height: 150px; width: 100%; margin-top: 10px;"></div>
                
                @if (currentRecommendation != null)
                {
                    <div class="mt-3 p-3 rounded bg-light-@currentRecommendation.Color border border-@currentRecommendation.Color">
                        <div class="d-flex align-items-center">
                            <div class="badge bg-@currentRecommendation.Color me-3 p-2">
                                <i class="bx @(currentRecommendation.Type == RecommendationType.Buy || currentRecommendation.Type == RecommendationType.StrongBuy ? "bx-trending-up" : "bx-trending-down") fs-4"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 text-@currentRecommendation.Color">Recomenda√ß√£o: @currentRecommendation.Message</h6>
                                <small class="text-muted">Baseado no RSI atual de @currentRecommendation.RSI.ToString("F2")</small>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
    <!--/ Main Chart -->

    <!-- Quick Calculator -->
    <div class="col-md-6 col-lg-4 order-2 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title m-0 me-2">Calculadora R√°pida</h5>
                <div class="dropdown">
                    <button class="btn p-0" type="button" id="calcOptions" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="bx bx-dots-vertical-rounded"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="calcOptions">
                        <a class="dropdown-item" href="javascript:void(0);" @onclick="UseMarketPrices">Usar Pre√ßos Atuais</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <ul class="p-0 m-0">
                    <li class="d-flex mb-4 pb-1">
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <h6 class="mb-0">NY (cts/lb)</h6>
                                <input type="number" step="0.01" class="form-control form-control-sm mt-1" @bind="nyPrice" @bind:event="oninput" style="width: 100px;" />
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <h6 class="mb-0">D√≥lar (R$)</h6>
                                <input type="number" step="0.0001" class="form-control form-control-sm mt-1" @bind="dollarRate" @bind:event="oninput" style="width: 100px;" />
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                         <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <h6 class="mb-0">Diferencial (R$)</h6>
                                <input type="number" step="1" class="form-control form-control-sm mt-1" @bind="basis" @bind:event="oninput" style="width: 100px;" />
                            </div>
                        </div>
                    </li>
                </ul>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary d-grid w-100" @onclick="Calculate">Calcular Agora</button>
                </div>
                
                 @if (calculatedPrice > 0)
                {
                    <div class="mt-3 text-center">
                        <small class="text-muted">Pre√ßo Sugerido (60kg)</small>
                        <h3 class="text-success mt-1">@Formatter.FormatCurrency(calculatedPrice)</h3>
                    </div>
                }
            </div>
        </div>
    </div>
    <!--/ Quick Calculator -->
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState>? authenticationStateTask { get; set; }
    private string UserName = "";

    private PriceUpdateDto arabicaPrice = new() { Ticker = "KC", CurrentPrice = 185.50m };
    private PriceUpdateDto conilonPrice = new() { Ticker = "C8", CurrentPrice = 145.20m };
    private PriceUpdateDto dollarPrice = new() { Ticker = "USDBRL", CurrentPrice = 5.25m };
    private PriceUpdateDto b3Price = new() { Ticker = "B3", CurrentPrice = 1000.00m };

    private decimal nyPrice;
    private decimal dollarRate;
    private decimal basis;
    private decimal calculatedPrice;
    private MarketRecommendation? currentRecommendation;
    private decimal currentSupport;
    private decimal currentResistance;
    private string currentInterval = "1h";
    private string currentRange = "5d";

    // Chart Data
    private List<ChartDataPoint> chartData = new();
    private List<decimal> priceHistory = new();
    private int period = 14;

    protected override async Task OnInitializedAsync()
    {
        if (authenticationStateTask != null)
        {
            var authState = await authenticationStateTask;
            UserName = authState.User.Identity?.Name ?? "";
        }

        MarketService.OnPriceUpdate += HandlePriceUpdate;
        await MarketService.StartAsync();

        nyPrice = arabicaPrice.CurrentPrice;
        dollarRate = dollarPrice.CurrentPrice;
        
        await LoadHistory();

        try
        {
            var settings = await Http.GetFromJsonAsync<MarketSettings>("api/marketsettings");
            if (settings != null) basis = settings.CoffeeBasis;
        }
        catch { }
    }

    private async Task LoadHistory()
    {
        try
        {
            var history = await Http.GetFromJsonAsync<List<ChartDataDto>>($"api/marketdata/history/KC?interval={currentInterval}&range={currentRange}");
            if (history != null && history.Any())
            {
                chartData = history.Select(h => new ChartDataPoint { time = h.Time, value = (double)h.Value }).ToList();
                priceHistory = history.Select(h => h.Value).ToList();
                
                // Technical Indicators
                if (priceHistory.Count >= period)
                {
                    var rsiValues = TechnicalIndicatorsService.CalculateRSI(priceHistory, period);
                    currentRecommendation = TechnicalIndicatorsService.GetRecommendation(rsiValues.Last());
                }

                // Support & Resistance
                var levels = TechnicalIndicatorsService.CalculateSupportResistance(priceHistory);
                currentSupport = levels.Support;
                currentResistance = levels.Resistance;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading history: {ex.Message}");
        }
    }

    private async Task ChangeTimeframe(string interval, string range)
    {
        currentInterval = interval;
        currentRange = range;
        await LoadHistory();
        
        // Re-render chart with new data
        await JSRuntime.InvokeVoidAsync("window.appInterop.createTradingViewChart", "incomeChart", chartData);
        
        // Add indicators for history
        var smaData = TechnicalIndicatorsService.CalculateSMA(priceHistory, period);
        var rsiData = TechnicalIndicatorsService.CalculateRSI(priceHistory, period);
        
        var smaPoints = chartData.Select((d, i) => new { time = d.time, value = (double)smaData[i] }).Where(p => p.value > 0).ToList();
        var rsiPoints = chartData.Select((d, i) => new { time = d.time, value = (double)rsiData[i] }).Where(p => p.value > 0).ToList();

        await JSRuntime.InvokeVoidAsync("window.appInterop.addIndicatorSeries", "incomeChart", "SMA", "#ff9f43", smaPoints);
        await JSRuntime.InvokeVoidAsync("window.appInterop.createRsiChart", "rsiChart", rsiPoints);
        await JSRuntime.InvokeVoidAsync("window.appInterop.syncCharts", "incomeChart", "rsiChart");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initial render with loaded history
            await JSRuntime.InvokeVoidAsync("window.appInterop.createTradingViewChart", "incomeChart", chartData);
            
            // Indicators for history
            if (priceHistory.Count >= period)
            {
                var smaData = TechnicalIndicatorsService.CalculateSMA(priceHistory, period);
                var rsiData = TechnicalIndicatorsService.CalculateRSI(priceHistory, period);
                
                var smaPoints = chartData.Select((d, i) => new { time = d.time, value = (double)smaData[i] }).Where(p => p.value > 0).ToList();
                var rsiPoints = chartData.Select((d, i) => new { time = d.time, value = (double)rsiData[i] }).Where(p => p.value > 0).ToList();

                await JSRuntime.InvokeVoidAsync("window.appInterop.addIndicatorSeries", "incomeChart", "SMA", "#ff9f43", smaPoints);
                await JSRuntime.InvokeVoidAsync("window.appInterop.createRsiChart", "rsiChart", rsiPoints);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("window.appInterop.addIndicatorSeries", "incomeChart", "SMA", "#ff9f43", new List<object>()); 
                await JSRuntime.InvokeVoidAsync("window.appInterop.createRsiChart", "rsiChart", new List<object>());
            }

            await JSRuntime.InvokeVoidAsync("window.appInterop.syncCharts", "incomeChart", "rsiChart");
        }
    }

    private void HandlePriceUpdate(PriceUpdateDto update)
    {
        switch (update.Ticker)
        {
            case "KC":
                arabicaPrice = update;
                var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
                var dataPoint = new ChartDataPoint { time = now, value = (double)update.CurrentPrice };
                
                // Update Charts
                JSRuntime.InvokeVoidAsync("window.appInterop.updateTradingViewChart", "incomeChart", dataPoint);
                
                AddPriceHistory(update.CurrentPrice);
                UpdateIndicators(now);
                break;
            case "C8": conilonPrice = update; break;
            case "USDBRL": dollarPrice = update; break;
            case "B3": b3Price = update; break;
        }
        InvokeAsync(StateHasChanged);
    }

    private void AddPriceHistory(decimal price)
    {
        priceHistory.Add(price);
        if (priceHistory.Count > 100) priceHistory.RemoveAt(0); // Maintain buffer
        chartData.Add(new ChartDataPoint { time = DateTimeOffset.UtcNow.ToUnixTimeSeconds(), value = (double)price });
    }

    private void UpdateIndicators(long timestamp)
    {
        if (priceHistory.Count >= period)
        {
            // SMA
            var smaValues = TechnicalIndicatorsService.CalculateSMA(priceHistory, period);
            var currentSMA = smaValues.LastOrDefault();
            if (currentSMA > 0)
            {
                var smaPoint = new { time = timestamp, value = (double)currentSMA };
                JSRuntime.InvokeVoidAsync("window.appInterop.updateIndicatorSeries", "incomeChart", "SMA", smaPoint);
            }

            // RSI
            var rsiValues = TechnicalIndicatorsService.CalculateRSI(priceHistory, period);
            var currentRSI = rsiValues.LastOrDefault();
            if (currentRSI > 0)
            {
                var rsiPoint = new { time = timestamp, value = (double)currentRSI };
                JSRuntime.InvokeVoidAsync("window.appInterop.updateRsiSeries", "rsiChart", rsiPoint);
                
                currentRecommendation = TechnicalIndicatorsService.GetRecommendation(currentRSI);
            }
        }
    }

    private void UseMarketPrices()
    {
        nyPrice = arabicaPrice.CurrentPrice;
        dollarRate = dollarPrice.CurrentPrice;
        Calculate();
    }

    private void Calculate()
    {
        calculatedPrice = CalculatorService.CalculateCoffeeBagPrice(nyPrice, dollarRate, basis);
    }

    public void Dispose()
    {
        MarketService.OnPriceUpdate -= HandlePriceUpdate;
    }

    public class ChartDataPoint
    {
        public long time { get; set; }
        public double value { get; set; }
    }
}
