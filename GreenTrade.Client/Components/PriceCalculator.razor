@using GreenTrade.Client.Services
@using GreenTrade.Shared.Services
@using GreenTrade.Shared.Models
@using System.Net.Http.Json

@inject IPriceCalculatorService Calculator
@inject FormatterService Formatter
@inject HttpClient Http
@inject IJSRuntime JS
@inject NotificationService Notifications

<div class="card overflow-hidden">
    <div class="card-header bg-success text-white py-3">
        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i> Calculadora de Preço Justo</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-6 col-md-3">
                <label class="form-label small text-muted text-uppercase fw-bold">NY (cts/lb)</label>
                <input type="number" step="0.01" class="form-control form-control-lg" @bind="nyPrice" @bind:event="oninput" />
            </div>
            <div class="col-6 col-md-3">
                <label class="form-label small text-muted text-uppercase fw-bold">Dólar (R$)</label>
                <input type="number" step="0.0001" class="form-control form-control-lg" @bind="dollarRate" @bind:event="oninput" />
            </div>
            <div class="col-12 col-md-3">
                <label class="form-label small text-muted text-uppercase fw-bold">Diferencial (R$)</label>
                <input type="number" step="1" class="form-control form-control-lg" @bind="basis" @bind:event="oninput" />
            </div>
            <div class="col-12 col-md-3 d-flex align-items-end">
                <button class="btn btn-outline-success w-100 btn-lg" @onclick="UseMarketPrices">
                    <i class="fas fa-sync-alt me-1"></i> Mercado
                </button>
            </div>
        </div>

        <div class="mt-4 p-4 rounded text-center" style="background-color: #f1f8e9; border: 2px dashed #c5e1a5;">
            <h6 class="text-muted text-uppercase mb-2 small fw-bold">Preço Sugerido por Saca</h6>
            <div class="d-flex justify-content-center align-items-center">
                <h2 class="text-success display-4 fw-bold mb-0">@Formatter.FormatCurrency(Result)</h2>
                <button class="btn btn-link text-success ms-2 p-0" @onclick="CopyResult" title="Copiar resultado">
                    <i class="far fa-copy fa-lg"></i>
                </button>
            </div>
            <p class="text-muted small mt-2 mb-0">Padrão: 60kg (Exportação)</p>
        </div>
    </div>
</div>

@code {
    [Parameter] public decimal CurrentArabica { get; set; }
    [Parameter] public decimal CurrentDollar { get; set; }

    private decimal nyPrice;
    private decimal dollarRate;
    private decimal basis;

    private decimal Result => Calculator.CalculateCoffeeBagPrice(nyPrice, dollarRate, basis);

    protected override async Task OnInitializedAsync()
    {
        nyPrice = CurrentArabica;
        dollarRate = CurrentDollar;
        
        try 
        {
            var settings = await Http.GetFromJsonAsync<MarketSettings>("api/marketsettings");
            if (settings != null)
            {
                basis = settings.CoffeeBasis;
            }
        }
        catch { }
    }

    private void UseMarketPrices()
    {
        nyPrice = CurrentArabica;
        dollarRate = CurrentDollar;
        Notifications.ShowInfo("Valores atualizados com dados do mercado.");
    }

    private async Task CopyResult()
    {
        var text = $"Preço Sugerido GreenTrade: {Formatter.FormatCurrency(Result)} (NY: {nyPrice}, USD: {dollarRate})";
        await JS.InvokeVoidAsync("clipboardCopy.copyText", text);
        Notifications.ShowSuccess("Resultado copiado para a área de transferência!");
    }
}
